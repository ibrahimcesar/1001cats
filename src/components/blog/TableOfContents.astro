---
/**
 * TableOfContents Component
 * Auto-generated TOC from post headings with active section highlighting
 */

import type { TocHeading } from '../../utils/toc';

interface Props {
  headings: TocHeading[];
}

const { headings } = Astro.props;

if (headings.length === 0) {
  return null;
}
---

<aside class="toc-container" aria-label="Table of contents">
  <nav class="toc">
    <h2 class="toc-title">On this page</h2>
    <ul class="toc-list">
      {headings.map((heading) => (
        <li class:list={['toc-item', `toc-depth-${heading.depth}`]}>
          <a
            href={`#${heading.slug}`}
            class="toc-link"
            data-heading-id={heading.slug}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
</aside>

<script>
  function initTableOfContents() {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('h2[id], h3[id]');

    if (tocLinks.length === 0 || headings.length === 0) return;

    // Add IDs to headings based on text content
    headings.forEach((heading) => {
      if (!heading.id) {
        const text = heading.textContent || '';
        const slug = text
          .toLowerCase()
          .replace(/[^\w\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .trim();
        heading.id = slug;
      }
    });

    // Track active section
    function updateActiveLink() {
      const scrollPosition = window.scrollY + 100; // Offset for header

      let currentHeading: Element | null = null;

      // Find the current heading based on scroll position
      headings.forEach((heading) => {
        const headingTop = (heading as HTMLElement).offsetTop;
        if (scrollPosition >= headingTop) {
          currentHeading = heading;
        }
      });

      // Update active state on TOC links
      tocLinks.forEach((link) => {
        const linkHref = link.getAttribute('href');
        const headingId = currentHeading?.id;

        if (linkHref === `#${headingId}`) {
          link.classList.add('active');
          link.setAttribute('aria-current', 'location');
        } else {
          link.classList.remove('active');
          link.removeAttribute('aria-current');
        }
      });
    }

    // Smooth scroll to heading
    tocLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const href = link.getAttribute('href');
        if (!href) return;

        const targetId = href.substring(1);
        const target = document.getElementById(targetId);

        if (target) {
          const yOffset = -80; // Offset for fixed header
          const y = target.getBoundingClientRect().top + window.pageYOffset + yOffset;

          window.scrollTo({ top: y, behavior: 'smooth' });

          // Update URL without jumping
          history.pushState(null, '', href);
        }
      });
    });

    // Update active link on scroll
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateActiveLink();
          ticking = false;
        });
        ticking = true;
      }
    });

    // Initial update
    updateActiveLink();
  }

  // Initialize on page load
  initTableOfContents();

  // Re-initialize on Astro page navigation
  document.addEventListener('astro:page-load', initTableOfContents);
</script>

<style>
  .toc-container {
    position: sticky;
    top: 6rem;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    margin-bottom: 2rem;
  }

  .toc-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin-bottom: 0.5rem;
  }

  .toc-depth-2 {
    margin-left: 0;
  }

  .toc-depth-3 {
    margin-left: 1rem;
    font-size: 0.875rem;
  }

  .toc-link {
    display: block;
    padding: 0.375rem 0.5rem;
    color: var(--text-secondary);
    text-decoration: none;
    border-left: 2px solid transparent;
    transition: all 200ms ease;
    line-height: 1.4;
  }

  .toc-link:hover {
    color: var(--accent-primary);
    border-left-color: var(--accent-primary);
    background: var(--bg-primary);
    border-radius: 0 0.25rem 0.25rem 0;
  }

  .toc-link.active {
    color: var(--accent-primary);
    border-left-color: var(--accent-primary);
    font-weight: 500;
  }

  .toc-link:focus-visible {
    outline: 2px solid var(--accent-primary);
    outline-offset: 2px;
  }

  /* Scrollbar styling */
  .toc-container::-webkit-scrollbar {
    width: 6px;
  }

  .toc-container::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: 3px;
  }

  .toc-container::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
  }

  .toc-container::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
  }

  /* Hide on smaller screens */
  @media (max-width: 1024px) {
    .toc-container {
      position: static;
      max-height: none;
    }
  }

  @media (max-width: 768px) {
    .toc-container {
      display: none;
    }
  }
</style>
